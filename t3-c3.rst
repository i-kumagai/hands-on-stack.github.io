スナップショットとリストア
================


概要
================

- ここでは作成しデータを書き込みしたボリュームのスナップショットを作成し、さらにそのスナップショットからボリュームをリストアします。
- リストアしたボリュームがスナップショット作成前のボリュームと同じ内容であることを確認します。

----

操作環境の準備
================
- はじめに操作環境を準備します。
- 「ボリュームの作成と接続」を実施している場合この操作は不要です。

コマンド実行の様子::

  ---- ここから ----
  ---- ここまで ----

----

DBの停止とアンマウント
================

- 最初にDBを停止してボリュームをアンマウントします。

コマンドの実行::

  --- ここから ---
  # ssh -i default.pem root@${FLOATINGIP}
  # service mysqld stop
  # umount /var/lib/mysql
  # exit
  # nova volume-detach ${} ${MY_VOL01}
  --- ここまで ---


スナップショットの作成
================

コマンドの実行::

  --- ここから ---
  # cinder list
  +--------------------------------------+-----------+--------------+------+-------------+----------+-------------+
  |                 ID                   |  Status   | Display Name | Size | Volume Type | Bootable | Attached to |
  +--------------------------------------+-----------+--------------+------+-------------+----------+-------------+
  | da3e922c-c98b-4f73-9b8c-7eb060bc466e | available | dbs_vol01    |  10  | standard    |  false   |             |
  +--------------------------------------+-----------+--------------+------+-------------+----------+-------------+

  # cider snapshot-create --display-name dbs_vol01-snap001 $
  --- ここまで ---

----




スナップショットの作成
================

コマンドの実行::

  --- ここから ---
  # nova volume-attach dbs01 $MY_DBS_VOL01
  +----------+--------------------------------------+
  | Property | Value |
  +----------+--------------------------------------+
  | device | /dev/vdc |
  | id | da3e922c-c98b-4f73-9b8c-7eb060bc466e |
  ...（以下省略）...

  # ssh -i default.pem root@${FLOATINGIP}
  # mount /var/lib/mysql/ && service mysqld start
  # sh /root/sample-app/server-setup/rest.init.sh restart
  # exit 

  --- ここまで ---

----

データの追加
================

- 画面からデータを追加します



----


スナップショットからのリストア
================

- 取得したスナップショットからデータをリストアします。

コマンドの実行::

  --- ここから ---
  
  # source getuuid.sh
  # export MY_DBS_VOL01_SNAP001=`cinder snapshot-show dbs_vol01-snap001 |get_uuid` 
  # echo $MY_DBS_VOL01_SNAP001
  # cinder create --snapshot-id $MY_DBS_VOL01_SNAP001 --display-name dbs_vol01_res 10
  # cinder list
  --- ここまで ---


リストアしたボリュームのマウント
================

- リストアしたボリュームをマウントし、データがスナップショット取得前に戻っていることを確認します。

コマンドの実行::

  --- ここから ---

  # nova volume-attach allinone-student03 151c7204-8486-4071-bcbb-c4e7f118e53b 
  +----------+--------------------------------------+
  | Property | Value                                |
  +----------+--------------------------------------+
  | device   | /dev/vdd                             |
  (後略)
  
  # ssh -i default.pem root@${FLOATINGIP}
  # lsblk
  NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT
  ～～～（中略）～～～
  vdc 252:32 0 10G 0 disk
    vdc1 252:33 0 10G 0 part /var/lib/mysql
  vdd 252:48 0 10G 0 disk
    vdd1 252:49 0 10G 0 part
  # service mysqld stop && umount /var/lib/mysql
  # mount /dev/vdd1 /var/lib/mysql/ && service mysqld start
  # mysql -u root sample_bbs -e 'select * from contents;'
  --- ここまで ---

----

サンプルアプリケーションの再起動
================

- サンプルアプリケーションを再起動し、ブラウザ上でもデータが前に戻っていることを確認します。


----

後片付け
===============

----



まとめ
===============



----


